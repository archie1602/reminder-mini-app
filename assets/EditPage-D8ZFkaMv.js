import{c as E,u as L,a as P,e as Y,i as $,j as e,E as d,C as q,f as K,h as X,k as G,r as x,l as Q,m as j,n as ee,U as l,o as te,S as se,B as F,I as re,p as ae,d as ne,R as oe}from"./index-HtsFE3xZ.js";import{u as ie,a as le,b as ce,g as T,h as de,c as me,d as ue,e as he,C as z,T as xe,f as fe,N as ge,S as pe,F as ve,i as be}from"./formHelpers-DJeyede9.js";/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ye=E("arrow-left",Ne);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],Ee=E("circle-alert",je);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]],we=E("rotate-cw",ke);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Se=E("wifi-off",Re),U=({error:r,onRetry:m,context:u="list",showBackButton:t=!0})=>{const{t:o}=L(),p=P(),c=Y(r),i=$(r),k=()=>{switch(c.errorCode){case d.NETWORK_ERROR:return e.jsx(Se,{className:"w-12 h-12 text-[var(--tg-theme-destructive-text-color)]"});case d.REMINDER_NOT_FOUND:return e.jsx(q,{className:"w-12 h-12 text-[var(--tg-theme-destructive-text-color)]"});default:return e.jsx(Ee,{className:"w-12 h-12 text-[var(--tg-theme-destructive-text-color)]"})}},w=()=>{switch(c.errorCode){case d.REMINDER_NOT_FOUND:return o(u==="edit"||u==="view"?"errors.reminderDeleted":"errors.reminderNotFound");case d.NETWORK_ERROR:return o("errors.networkErrorRetry");case d.UNAUTHORIZED:return o("errors.unauthorized");case d.FORBIDDEN:return o("errors.forbidden");case d.INTERNAL_SERVER_ERROR:return o("errors.serverError");default:return c.message||o("errors.unknownError")}},R=()=>{p("/")};return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px] p-6 text-center",children:[e.jsx("div",{className:"mb-4",children:k()}),e.jsx("h2",{className:"text-lg font-semibold text-[var(--tg-theme-text-color)] mb-2",children:o("common.error")}),e.jsx("p",{className:"text-[var(--tg-theme-hint-color)] mb-6 max-w-sm",children:w()}),!1,e.jsxs("div",{className:"flex gap-3",children:[t&&(c.errorCode===d.REMINDER_NOT_FOUND||u!=="list")&&e.jsxs("button",{onClick:R,className:"inline-flex items-center gap-2 px-4 py-2 bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)] rounded-lg font-medium transition-opacity active:opacity-80",children:[e.jsx(ye,{className:"w-4 h-4"}),o("errors.goBack")]}),i&&m&&e.jsxs("button",{onClick:m,className:"inline-flex items-center gap-2 px-4 py-2 bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)] rounded-lg font-medium transition-opacity active:opacity-80",children:[e.jsx(we,{className:"w-4 h-4"}),o("errors.tryAgain")]})]})]})},Ce=5;function Te(){const{t:r}=L(),m=P(),{id:u}=K(),{data:t,isLoading:o,error:p}=X(u),c=G(),[i,k]=x.useState(null),[w,R]=x.useState([]),{control:v,handleSubmit:_,formState:{errors:f},setValue:V,watch:b,reset:A}=ie({resolver:le(be),mode:"onChange"}),{fields:N,append:W,remove:Z}=ce({control:v,name:"schedules"});x.useEffect(()=>{t&&!Q(t.status)&&t.status===j.Paused&&(alert(r("reminder.pausedCannotEdit")),m("/"))},[t,m,r]),x.useEffect(()=>{if(t&&t.schedules){const s=t.status===j.Ended?t.schedules.filter(n=>!ee(n)):t.schedules,a={text:t.text||"",timeZone:t.timeZone||T(),schedules:s.map(n=>({rule:n.rule}))};if(A(a),k(a),R(s.map(n=>n.id)),t.status===j.Ended&&s.length<t.schedules.length){const n=t.schedules.length-s.length;console.info(`Removed ${n} expired schedule(s)`)}}},[t,A]);const I=async s=>{if(!u||!i)return;const a=[],n=[],C=s.schedules||[],M=i.schedules||[];if(M.forEach((D,B)=>{const O=C[B],y=w[B];O?JSON.stringify(D.rule)!==JSON.stringify(O.rule)&&y&&(a.push(y),n.push(O)):y&&a.push(y)}),C.length>M.length){const D=C.slice(M.length);n.push(...D)}await c.mutateAsync({id:u,data:{text:s.text,scheduleOperations:{delete:a.length>0?a:void 0,add:n.length>0?n:void 0}}}),m("/")},g=b(),h=x.useMemo(()=>{if(!i||!g)return!1;if(i.text!==g.text||i.schedules.length!==g.schedules?.length)return!0;for(let s=0;s<i.schedules.length;s++){const a=i.schedules[s],n=g.schedules?.[s];if(!n||JSON.stringify(a.rule)!==JSON.stringify(n.rule))return!0}return!1},[i,g]),S=de(f),H=me({hasUnsavedChanges:h,onBackClick:()=>m("/")});x.useEffect(()=>{if(l.mount.isAvailable())return l.isMounted()||l.mount(),h?l.enableConfirmation.isAvailable()&&l.enableConfirmation():l.disableConfirmation.isAvailable()&&l.disableConfirmation(),()=>{l.disableConfirmation.isAvailable()&&l.disableConfirmation()}},[h]),ue(H),he({text:r("common.save"),onClick:_(I),enabled:!S&&!c.isPending&&h});const J=()=>{const s=b("timeZone")||T(),a=ne().tz(s).add(1,"hour").format("YYYY-MM-DDTHH:mm:ss");W({rule:{type:oe.OneTime,oneTime:{fireAt:a}}})};return p?e.jsx("div",{className:"min-h-screen bg-[var(--tg-theme-bg-color)] p-4 pb-20",children:e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsx(U,{error:p,context:"edit",showBackButton:!0})})}):!o&&!t?e.jsx("div",{className:"min-h-screen bg-[var(--tg-theme-bg-color)] p-4 pb-20",children:e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsx(U,{error:{message:r("errors.reminderNotFound")},context:"edit",showBackButton:!0})})}):e.jsx(te,{isLoading:o,hasInitialData:!!t,skeleton:e.jsx("div",{className:"min-h-screen bg-[var(--tg-theme-bg-color)] p-4 pb-20",children:e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsx(ae,{})})}),children:t?e.jsx("div",{className:"min-h-screen bg-[var(--tg-theme-bg-color)] p-4 pb-20",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold text-[var(--tg-theme-text-color)] mb-6",children:r("reminder.editTitle")}),t.status===j.Ended&&e.jsx("div",{className:"bg-yellow-500/10 border border-yellow-500/30 text-yellow-600 dark:text-yellow-400 p-3 rounded-lg mb-4",children:e.jsx("p",{className:"text-sm",children:r("reminder.endedEditInfo")})}),e.jsxs("form",{className:"space-y-6",children:[e.jsx(z,{name:"text",control:v,render:({field:s})=>e.jsx(xe,{...s,label:r("reminder.text"),placeholder:r("reminder.textPlaceholder"),error:f.text?.message?r(f.text.message):void 0,rows:3})}),e.jsx(z,{name:"timeZone",control:v,render:({field:s})=>e.jsx(se,{...s,value:s.value||"",label:r("reminder.timezone"),options:fe(),searchable:!0,disabled:!0})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-[var(--tg-theme-text-color)]",children:r("reminder.schedules")}),N.length===0&&e.jsx(ge,{}),N.map((s,a)=>e.jsx(pe,{index:a,control:v,setValue:V,watch:b,onRemove:()=>Z(a),timezone:b("timeZone")||T(),isNew:a===N.length-1,hasError:!!f.schedules?.[a]},s.id)),N.length<Ce?e.jsx(F,{variant:"secondary",onClick:J,className:"text-sm py-2 px-4 w-full",type:"button",children:r("common.addSchedule")}):e.jsxs("div",{className:"text-sm text-[var(--tg-theme-hint-color)] text-center py-2 flex items-center justify-center gap-1",children:[e.jsx(re,{size:16,className:"inline-block flex-shrink-0"}),r("reminder.maxSchedulesReached")]})]}),e.jsx(ve,{errors:f,isVisible:S}),e.jsx(F,{onClick:_(I),disabled:S||c.isPending||!h,fullWidth:!0,title:h?void 0:r("reminder.noChangesDetected"),children:r("common.save")})]})]})}):null})}export{Te as default};
